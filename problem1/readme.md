Solution
========

The solution to this problem is to fine-tune a model so that it can generate the wavedrom code for a given image of a timing diagram.
In order to do this, we need to generate a dataset of images and their corresponding wavedrom code. We can then use this dataset to fine-tune a model to generate the wavedrom code for a given image.


## Dataset Generation


The dataset generation process is as follows:


![image](documentation_images/data_generation_architecture.png)



1. Generate the test benches for each of the modules in the dataset.
See generate_tb.sh for more details on the variables used in this command.
```
gentbvlog -in "$FILE" -top "${MODULE}" -out "${TRAIN_DIR}/${BASENAME}_tb.v" -rst "reset" -max_sim_time 199
```

2. Augment the test benches for the VCD files. Add these lines to the test benches inside the intial/begin block. See augment_testbench.ipynb for more details.
(Currently broken so this is done manually.)
```
$dumpfile("file_name.vcd");
$dumpvars(0,testbench);
```

3. Run the simulation for each module using iverilog(see generate_vcd.ipynb ).
```
 cmd = "iverilog -o " + path + "/" + str(i+1) + " " +path + "/" + prog_name + " " + path + "/" + tb_name;
```

4. Generate the vcd file using vpp.
```
vvp train/1 && mv 1.vcd train/
```

5. Convert the vcd file to wavedrom code using the vcd2wavedrom tool.
```
python -m vcd2wavedrom.vcd2wavedrom -i train/1.vcd >> train/1.out
```

6. Generate the image of the timing diagram using the wavedrom code either using the wavedrom online tool or the wavedrom-cli tool.
```
wavedrom-cli -i train/1.out -s 1 -o train/1.png
```


These steps are now integrated in the generate_dataset.py script.
Usage:
```
python generate_dataset.py
```
This will generate the full dataset in the wavedrom_dataset directory. The dataset consists of the following folders:
```
wavedrom_dataset/
├── verilog_modules
│   ├── 0.v
│   ├── 1.v
├── iverilog_output
│   ├── 0.out
│   ├── 1.out
├── testbenches
│   ├── 0_tb.v
│   ├── 1_tb.v
├── vcd
│   ├── 0.vcd
│   ├── 1.vcd
├── wavedrom
│   ├── 0.json
│   ├── 1.json
|── timing_diagrams
│   ├── 0.png
│   ├── 1.png
```
The `verilog_modules` folder contains the verilog modules used in the dataset. The `iverilog_output` folder contains the output of the iverilog simulation. The `testbenches` folder contains the testbenches used to generate the vcd files. The `vcd` folder contains the vcd files generated by the simulation. The `wavedrom` folder contains the wavedrom code generated from the vcd files. The `timing_diagrams` folder contains the images of the timing diagrams generated from the wavedrom code.
The `wavedrom_dataset` folder contains the full dataset used to train the model. The dataset consists of 100 images and their corresponding wavedrom code. The images are in png format and the wavedrom code is in json format. The wavedrom code is in the form of a json object. The json object contains the following fields:
```
{
    "signal": [
        {
            "name": "clk",
            "wave": "p....",
            "data": ["0", "1", "0", "1"]
        },
        {
            "name": "rst",
            "wave": "0.1..",
            "data": ["0", "1", "0"]
        }
    ]
}
```

By doing this the dataset is reproducible as the testbenches and vcd files are given.